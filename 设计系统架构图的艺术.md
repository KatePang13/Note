# 设计系统架构图的艺术

origin:   https://www.infoq.com/articles/crafting-architectural-diagrams/

## 概述

- 设计系统架构图并不是一件容易的事；即使是对于一个很简单的系统也是如此。创造一致(这里指的是系统与架构图示的一致)的且有意义的示意图，可以便于他人更清晰的理解，在不同的团队之间产生共识。
- 在大多数情况下，真正的问题并不在于架构描述语言的低效，而在于对图示重要性的忽视，在于依靠不正确或不一致的准则，甚至是系统架构教育的缺失

- 在创建图示的过程中，要结合自动生成和手动绘制，以最大程度地减少工作量，说明不同的关注点并涵盖系统的多个抽象级别
- 当系统演进时，保持图示的更新需要额外的精力。我们需要知道如何高效地迭代，以保持架构图示的一致性和鲁棒性
- 现代架构体系引入的复杂性也同样体现在示意图中，更多的问题也随之而来

在某些时候，我们参与的软件工程可能会需要制作系统架构图。不管我们是否遵循常规的的架构模型(比如 [Kruchten 4+1 模型](4+1 architectural view model) 或者 [Rozanski & Woods 模型 等](https://www.pearson.com/us/higher-education/program/Rozanski-Software-Systems-Architecture-Working-With-Stakeholders-Using-Viewpoints-and-Perspectives-2nd-Edition/PGM312200.html) )  ，都需要制作图示来记录应用程序的某些部分。在软件体系结构中，图示通常是根据与可能属于模型的特定观点相关的视图创建的，但是在当前文章中，我倾向于坚持使用术语“体系结构图”，而不是非常正式的形式。其他所有方面均不打算在这里涵盖。

根据我担任多年来软件架构师和技术培训师的经验，项目之间以及项目团队内部各开发人员之间，在开发架构图的方式上的差异体是巨大的。我看过很多不成功的案例，比如图示与所呈现信息不一致，信息过于碎片化等问题。与必须正式和标准化的架构模型相比，这些图可能不一定要形式化或遵循特定的标准。

不管怎么样，图示必须是**自描述的**，**一致的**，**准确的**，**与代码相关联的**。所以，每个架构师或工程师在创建架构图是，必须遵循多个准则，因为架构图是随时间推移的（比如结构，元素，关系，属性，原理等），架构图也是不同团队之间的桥梁，他们可能拥有完全不同的技术背景和关注点。

## 设计架构图时面临的问题

在深入讨论可能的问题之前，我想引用一句谚语"a picture is worth a thousand words".   [wiki](https://en.wikipedia.org/wiki/A_picture_is_worth_a_thousand_words)  上解释道：“一个复杂的想法可以用一张图来传达，或者说一个示意图可能比大篇幅的文字说明更能解释问题”。对于一个架构图来说也是一样的：如果一个架构图带来的更多的疑问而不是答案，这肯定不是一个好的示意图。请不要让一个架构图需要大量的注释来说明问题。

![img](https://res.infoq.com/articles/crafting-architectural-diagrams/en/resources/picture.jpg)

上图是一个错误的示范，它涉及到下面将谈到的很多问题。

以下是我们在设计架构图时可能会遇到的种种陷阱。

- 不同的方框代表什么？

- 方框的不同的边界代表什么？
- 颜色代表什么？
- 图表元素和孤立实体之间缺少关系
- 使用误导性的缩写或者不明确的术语
- 过分强调 技术细节：比如框架，编程语言，IDE 或者开发方法
- 混合 运行时元素 和 静态元素
- 做成诸如: "我将口头解释这一点" 或者 “稍后再解释” 之类的假设
- 混淆不同的抽象级别
- 示意图过于混乱和模糊，过于详细或过于概况



## 设计架构图的准则

- 确定最合适的示意图数量
  - Philippe Kruchten 说过，"体系结构是一个复杂的野兽，使用一个蓝图来表示体系结构会造成语义混乱。"  为了记录现代体系结构，我们不能仅仅用一张示意图的表示。但是决定使用哪种图和几张图，就是一个很头疼的事情了，需要考虑多个因素，比如架构的性质和复杂度，架构师的技巧和经验，可用的时间，维护它们所需的工作量，以及利益相关者的关注点等。比如，网络工程师可能希望看到一个明确的网络模型，包括主机，通信端口和协议；数据库管理员关心的是如何操作，管理和分发数据。基于所有这些方面，来选择合适数量的示意图。
  - 如果没有足够的图表（例如文档不足），则架构的某些部分可能是不可见的，或是文档缺失的;另一方面，如果太多（例如，文档过多），则保持一致性，持续更新，且保持不零散 等就需要更大的工作量。
- 示意图之间保持结构和语义上的一致性
  - 对于所有的图，方框，边框，线条，颜色等都应该保持一致。结构外观应当相同，涉及的相关人员在理解上应该没有困难，即使是由其他人员制造的图示。最理想的情况是，并在所有项目中使用通用的，统一的图表工具。
  - 从语义的角度来看，所有这些图都应定期地同步最新的代码更改，图之间也应该保持同步，因为一个图的更改可能会影响其他的图。可以使用建模工具手动或自动触发此过程。后者是首选的机制，但这取决于项目之间的关系，在所有情况下，其思想是保持图和代码之间的一致性，而与方法或工具无关。西蒙·布朗说：“图示如果不与代码连接，则图示对与体系结构的改进是没有用”，它强调了语义一致性的思想。
- 防止碎片化
  - 拥有多个图表可能会使架构描述难以理解，同时也需要更多的精力来维护它，另外，碎片化问题也可能随之出现（例如，两个或多个图表说明了相同的质量属性-性能，可伸缩性等-但每个图都不完整）。在这种情况下，要么删除不反映相关质量属性的图（链接到对体系结构很重要的要求），更好的做法是，合并这些图。
- 保证图示的可追溯性
  - 为了能够检查历史记录，在不同图表版本之间进行比较以及轻松地还原到先前版本，可追溯性是一个重要的指标。使用不支持该需求的建模工具可能会成为障碍。业界的最新趋势是依靠使用简单直观的纯文本语言来生成图表，这似乎解决了可追溯性问题。这种方法的另一个优点是，它隐式地确保了图之间的结构一致性。
- 在结构图旁边添加图例
  - 如果您不遵循标准的架构描述语言（例如UML，ArchiMate），请在图例中详细说明图表的每一部分（例如框，形状，边框，线条，颜色，首字母缩写等）
  - 如果不是这种情况，则在图例中只需添加架构描述语言作为关键字即可，并且不需要其他解释，因为每个读者都将遵循该语言细节来理解该图。

## 体系结构描述语言之间有什么不同？（UML, ArchiMate 等）

哪种描述语言更好，这是一个备受争议的问题 。有人可能会认为，UML是僵化的，不够灵活，无法对体系结构设计进行建模，我同意这一观点。但是，在某些情况下，在不依赖任何UML可扩展性特性（如概要文件和构造型）的情况下，记录架构的基础可能绰绰有余。

对于其他的描述语言，与UML相比，[ArchiMate](http://www.opengroup.org/subjectareas/enterprise/archimate) 更强大并且更适合于对企业系统进行建模。还有  [BPMN](http://www.bpmn.org/)，它特别符合业务流程。这里不打算对它们进行任何深入的讨论，因为这不是本文的目的。

 拥有足够全面和灵活的体系结构描述语言是至关重要的。但是从我的角度来看，真正的原因位于其他地方，并且与根本没有创建架构文档这一事实有关。人们常常发现创建它很无聊，无用或毫无意义。没有文档或没有正确文档的软件项目数量巨大。我认为 主要原因是人们没有找到合适的秒速语言，如果用更好的描述语言，结果将大不相同。人们通常没有创建任何体系结构文档（包括体系结构图），更糟糕的是，大多数人都不知道如何正确创建文档。这些是我们首先要解决的事情-了解文档为什么重要以及如何正确创建文档；然后自然会选择合适的工具。



## 随着系统的开发，如何使图保持最新状态，并对体系结构进行更改

保持图表更新的方法很少。下面我将介绍其中的三个。第一种选择也是最简单的选择，是根据源代码自动生成图表，这是基本事实。这保证了它们都与代码一致。不幸的是，使用现有工具还无法完全实现（至少据我所知），因为实际的工具仅靠源代码就无法在没有大量人工干预的情况下创建任何类型的准确而有意义的图表。 Len Bass说：“理想的开发环境是只需按一下按钮即可免费获得其文档的环境”，隐式自动生成图表，但我们还没有达到这一点。 第二种方法是首先使用专用工具设计图表，然后生成源代码框架（例如具有边界的组件/包，API），供开发人员稍后使用以填充代码。这样，架构中的每个更改都需要从图本身触发，这可能会自动重新生成或更新代码框架。 最后一种情况是每次实施新功能时都会手动更新图，这会对体系结构设计产生影响。为了确保所有代码更改都反映在图中，建议将更新图作为开发过程中完成的定义的一部分。不建议使用这种情况，因为这种情况很容易导致过时或不一致的图表（例如，开发人员经常忘记或不愿意更新图表），不幸的是，在大多数项目中仍然会发生这种情况。 考虑到现有工具，我的建议是混合使用。自动混合并手动创建图。例如，尝试自动生成图表，该图表可以由基于源代码的工具合理地渲染，而不会产生太多干扰（例如，过于混乱或无意义的信息）。在这一类别中，我们可以包括波动性高的图表（例如，更容易发生频繁的开发更改，通常具有较低的抽象度）或相反的静态图表。一些这样的图可能引用上下文图，参考体系结构图，包图，类图，实体图等。但是，在某些情况下，仅基于源代码，系统如何满足某些质量属性（例如，可用性）并不明显。 ，可伸缩性，性能），因此自动创建图表是不够的选择。它需要通过手动建模的图表进行补充。此类图的一些示例包括顺序图，状态图，并发图，部署图，操作图等。



## 在处理现代体系结构（例如微服务）时，体系结构图会出现哪些复杂性（或简化）？

微服务或任何其他现代架构风格（例如，无服务器，事件驱动）仅驱动系统的结构，组件之间的通信方式（例如它们之间的关系）以及管理它们的原则。就我个人而言，我不认为架构风格应该改变创建图表（以及隐式地进行架构描述）的原理或概念，也不应该改变它们的内容。但是，当我们谈论现代系统体系结构时，与旧的和古典的系统相比，它们通常具有更高的复杂性（例如，整体式），它们肯定会影响体系结构描述，并隐含地影响图表，因为存在多个注意事项。这些考虑可能是关于理解分布式组件的数量（例如分布式微服务），每个组件的类型，组件如何相互通信（例如边界，API，消息），它们的生命周期以及谁拥有每个组件。 考虑到所有这些因素，默认情况下应考虑捕获系统分解，开发，部署和可操作性的视图。例如，想象一下一个拥有大量微服务的系统；在这种情况下，图的数量可能会显着增加，因为每个微服务可能最终都有自己的一组图。有关一致性（例如，更改一项服务的API会影响其他多个服务，因此需要更新所有受影响的图），碎片（例如，分布式服务之间的高可用性或性能未合并到一个图中）或跨领域问题（例如，负责以统一方式说明整个系统元素中的监视或安全性等方面的问题的人员可能不容易处理。最重要的是，在项目开发过程中，甚至在此之后，团队维护，共存和协作都可能带来挑战。 总而言之，具有复杂体系结构的现代系统可能会带来其他问题，即使在图级别上也可能导致复杂性。